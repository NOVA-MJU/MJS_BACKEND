name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ Checkout source code
        uses: actions/checkout@v3

      - name: ğŸ” Set up SSH key
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: ğŸš€ Deploy to EC2 via SSH
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << "EOF"
            set -e  # ì—ëŸ¬ ë°œìƒ ì‹œ ì¦‰ì‹œ ì¤‘ë‹¨

            echo "[1] í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ì´ë™"
            cd /home/ubuntu/MJS_BACKEND

            echo "[2] ì‹¤í–‰ ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ"
            PID=\$(pgrep -f 'MJS_BACKEND-0.0.1-SNAPSHOT.jar' || true)
            if [ -n "\$PID" ]; then
              kill -9 \$PID
              echo "ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œë¨: \$PID"
            else
              echo "ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì—†ìŒ"
            fi

            echo "[3] ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°"
            git pull origin main

            echo "[4] Gradle ë¹Œë“œ ì‹œì‘"
            ./gradlew clean
            ./gradlew build -x test

            echo "[5] ì‹¤í–‰ JAR ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰"
            cd build/libs
            JAR_FILE=\$(ls *.jar | head -n 1)
            nohup java -jar \$JAR_FILE > nohup.out 2>&1 &

            echo "âœ… ë°°í¬ ì™„ë£Œ: \$JAR_FILE ì‹¤í–‰ë¨"
          EOF
