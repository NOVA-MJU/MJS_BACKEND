name: Deploy to EC2

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ Checkout
        uses: actions/checkout@v4

      - name: ğŸ” SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      # ì›ê²©ì—ì„œ ì‹¤í–‰í•  ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë¡œì»¬ì— ìƒì„±
      - name: ğŸ“ Create remote deploy script (locally)
        shell: bash
        run: |
          cat > deploy_remote.sh <<'EOS'
          #!/usr/bin/env bash
          set -Eeuo pipefail

          # === ê³ ì • ë³€ìˆ˜(Secrets ì¶”ê°€ ë¶ˆí•„ìš”) ===
          APP_DIR="/home/ubuntu/MJS_BACKEND"
          SERVICE_NAME="MJS_BACKEND"
          APP_PORT="8080"
          JAR_NAME="MJS_BACKEND-0.0.1-SNAPSHOT.jar"
          JAR_PATH="${APP_DIR}/build/libs/${JAR_NAME}"

          # í—¬ìŠ¤ì²´í¬ ìµœëŒ€ ëŒ€ê¸°(ì´ˆ) - ê¸°ë³¸ 60ì´ˆ (í•„ìš”ì‹œ SSH ì‹¤í–‰ ì‹œ MAX_WAIT=45ì²˜ëŸ¼ ë®ì–´ì“°ê¸° ê°€ëŠ¥)
          MAX_WAIT="${MAX_WAIT:-60}"

          log(){ printf "\n[%(%F %T)T] %s\n" -1 "$*"; }
          trap 'log "âŒ ì‹¤íŒ¨: ë¼ì¸ $LINENO (ëª…ë ¹: $BASH_COMMAND)"; exit 1' ERR

          log "who=$(whoami) host=$(hostname)"
          set -x

          # 0) github í˜¸ìŠ¤íŠ¸í‚¤ ë“±ë¡(ì²« ì‹¤í–‰ì‹œ í”„ë¡¬í”„íŠ¸ ë°©ì§€)
          ssh-keyscan -H github.com | sudo tee -a /etc/ssh/ssh_known_hosts > /dev/null || true

          # 1) í”„ë¡œì íŠ¸ ì´ë™
          cd "${APP_DIR}"

          # 2) ë©”ì¸ ë ˆí¬ ìµœì‹ í™”(ì•ˆì „: main ê³ ì • + Fast-forwardë§Œ)
          git fetch origin
          git checkout main
          git pull --ff-only origin main

          # 3) ì„œë¸Œëª¨ë“ˆ ìµœì‹ í™” (branch=main ì¶”ì )
          #    .gitmodules: url=git@github.com:NOVA-MJU/MJS-BACK-SECURITY.git, branch=main
          git submodule sync --recursive
          git submodule update --init --recursive --remote
          git submodule foreach --recursive 'git reset --hard || true'
          git submodule foreach --recursive 'git clean -fdx || true'

          # 4) ë¹Œë“œ (clean -> bootJar)
          chmod +x ./gradlew || true
          ./gradlew --version
          ./gradlew clean bootJar -x test

          # 5) ì‚°ì¶œë¬¼ í™•ì¸
          test -f "${JAR_PATH}" || { set +x; log "âŒ JAR ë¯¸ì¡´ì¬: ${JAR_PATH}"; exit 1; }

          # 6) systemd ì¬ì‹œì‘
          sudo systemctl daemon-reload || true
          sudo systemctl restart "${SERVICE_NAME}"

          set +x
          # 7) ë¹ ë¥¸ í—¬ìŠ¤ì²´í¬ (ì¡°ê¸°ì„±ê³µ: ë¡œê·¸/HTTP/í¬íŠ¸ ì¤‘ í•˜ë‚˜ë¼ë„ OK, ìµœëŒ€ ${MAX_WAIT}s)
          alive(){ systemctl is-active --quiet "${SERVICE_NAME}"; }
          ready_by_log(){
            # Spring Bootì˜ ê¸°ë™ ì™„ë£Œ ë¡œê·¸ ì‹œê·¸ë„ë“¤
            journalctl -u "${SERVICE_NAME}" -n 400 --no-pager 2>/dev/null | \
              grep -Eq "Started .* in .* seconds|Tomcat started on port|Starting ProtocolHandler|Started MjsApplication"
          }
          ready_by_http(){ command -v curl >/dev/null 2>&1 && curl -fsS "http://127.0.0.1:${APP_PORT}/actuator/health" >/dev/null 2>&1; }
          ready_by_port(){ (command -v ss >/dev/null 2>&1 && ss -lnt | grep -q ":${APP_PORT} ") || (command -v nc >/dev/null 2>&1 && nc -z 127.0.0.1 "${APP_PORT}"); }

          log "ğŸ©º í—¬ìŠ¤ì²´í¬ ì‹œì‘(ìµœëŒ€ ${MAX_WAIT}s)"
          for i in $(seq 1 "${MAX_WAIT}"); do
            if ! alive; then
              log "âŒ ì„œë¹„ìŠ¤ ë¹„í™œì„± (ì¡°ê¸° ì¢…ë£Œ)"
              sudo systemctl --no-pager --full status "${SERVICE_NAME}" || true
              journalctl -u "${SERVICE_NAME}" -n 200 --no-pager || true
              exit 1
            fi
            if ready_by_log || ready_by_http || ready_by_port; then
              log "âœ… ì¤€ë¹„ ì™„ë£Œ (~${i}s)"
              exit 0
            fi
            sleep 1
          done

          log "âš ï¸ ${MAX_WAIT}s ë‚´ ì¤€ë¹„ ì‹ í˜¸ ë¯¸í™•ì¸ â€” ìµœê·¼ ìƒíƒœ/ë¡œê·¸"
          sudo systemctl --no-pager --full status "${SERVICE_NAME}" || true
          journalctl -u "${SERVICE_NAME}" -n 200 --no-pager || true
          exit 1
          EOS

          chmod +x deploy_remote.sh
          ls -al deploy_remote.sh
          head -n 20 deploy_remote.sh

      - name: ğŸ“¤ Upload deploy script to EC2
        shell: bash
        run: |
          scp -o StrictHostKeyChecking=no ./deploy_remote.sh \
            "${{ secrets.EC2_USER }}"@"${{ secrets.EC2_HOST }}":/home/ubuntu/deploy_remote.sh

      - name: ğŸš€ Run deploy script on EC2 (MAX_WAIT=60)
        shell: bash
        run: |
          ssh -o StrictHostKeyChecking=no "${{ secrets.EC2_USER }}"@"${{ secrets.EC2_HOST }}" \
            "MAX_WAIT=60 bash /home/ubuntu/deploy_remote.sh"

      - name: ğŸ“œ Show service status & logs (always)
        if: always()
        run: |
          ssh -o StrictHostKeyChecking=no "${{ secrets.EC2_USER }}"@"${{ secrets.EC2_HOST }}" \
            "sudo systemctl --no-pager --full status MJS_BACKEND || true"
          ssh -o StrictHostKeyChecking=no "${{ secrets.EC2_USER }}"@"${{ secrets.EC2_HOST }}" \
            "journalctl -u MJS_BACKEND -n 120 --no-pager || true"
