name: Deploy to EC2

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ Checkout
        uses: actions/checkout@v3

      - name: ğŸ” SSH agent
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: ğŸš€ Deploy over SSH
        shell: bash
        run: |
          ssh -o StrictHostKeyChecking=no "${{ secrets.EC2_USER }}"@"${{ secrets.EC2_HOST }}" bash -s << "EOF"
          set -euo pipefail

          echo "[1] í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ì´ë™"
          cd /home/ubuntu/MJS_BACKEND

          echo "[2] ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ"
          PID=$(pgrep -f 'MJS_BACKEND-.*\.jar' || true)
          if [ -z "${PID:-}" ]; then
            PID=$(pgrep -f 'MJS_BACKEND-0.0.1-SNAPSHOT.jar' || true)
          fi
          if [ -n "${PID:-}" ]; then
            kill -9 "$PID" || true
            echo "â¡ ì¢…ë£Œ: $PID"
          else
            echo "â¡ ì‹¤í–‰ ì¤‘ í”„ë¡œì„¸ìŠ¤ ì—†ìŒ"
          fi

          echo "[3] ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸° (git pull)"
          git pull origin main

          echo "[4] Gradle ë¹Œë“œ (clean â†’ build -x test)"
          chmod +x ./gradlew || true
          ./gradlew clean
          ./gradlew build -x test

          echo "[5] build/libs ì´ë™ ë° JAR ì‹¤í–‰"
          cd build/libs
          ls -al || true

          # JAR ì„ íƒ (ê³ ì •ëª… ë¨¼ì €, ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ .jar)
          JAR_FILE="MJS_BACKEND-0.0.1-SNAPSHOT.jar"
          if [ ! -f "\$JAR_FILE" ]; then
            JAR_FILE=$(ls -1 *.jar 2>/dev/null | head -n 1 || true)
          fi
          if [ -z "${JAR_FILE:-}" ] || [ ! -f "\$JAR_FILE" ]; then
            echo "âŒ JAR íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. (build/libs ë¹„ì–´ìˆìŒ)"
            exit 1
          fi
          echo "â¡ ì‹¤í–‰ ëŒ€ìƒ: \$JAR_FILE"

          # ì´ì „ ë¡œê·¸ ë°±ì—…
          mv nohup.out "nohup_$(date +%Y%m%d_%H%M%S).log" 2>/dev/null || true

          # ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰
          nohup java -jar "\$JAR_FILE" > nohup.out 2>&1 &

          echo "âœ… ê¸°ë™ ì™„ë£Œ: \$JAR_FILE (PID: $!)"
          sleep 1
          tail -n 20 nohup.out || true
          EOF
