name: Deploy to EC2

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ Checkout
        uses: actions/checkout@v3

      - name: ğŸ” SSH agent
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      # ì›ê²©ì—ì„œ ì‹¤í–‰í•  ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë¡œì»¬ì— ìƒì„±
      - name: ğŸ“ Create remote deploy script (locally)
        shell: bash
        run: |
          cat > deploy_remote.sh <<'EOS'
          #!/usr/bin/env bash
          # -e: ì—ëŸ¬ ì‹œ ì¢…ë£Œ, -u: ë¯¸ì •ì˜ ë³€ìˆ˜ ì—ëŸ¬, -o pipefail: íŒŒì´í”„ë¼ì¸ ì¤‘ê°„ ì—ëŸ¬ ê°ì§€, -x: ì‹¤í–‰ ì»¤ë§¨ë“œ echo
          set -euo pipefail
          set -x

          APP_DIR="/home/ubuntu/MJS_BACKEND"
          APP_NAME="MJS_BACKEND"
          DEFAULT_JAR="MJS_BACKEND-0.0.1-SNAPSHOT.jar"
          APP_PORT="${APP_PORT:-8080}"   # í•„ìš”ì‹œ Secrets/Envë¡œ êµì²´

          echo "[whoami]"; whoami
          echo "[hostname]"; hostname
          echo "[date]"; date
          echo "[java -version]"; java -version || true

          echo "[1] í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ì´ë™"
          cd "$APP_DIR"
          pwd
          ls -al

          echo "[1.1] Git ìƒíƒœ ì¶œë ¥"
          git rev-parse --abbrev-ref HEAD || true
          git log -1 --oneline || true
          git status -sb || true

          echo "[2] ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ"
          # JAR ì´ë¦„ì´ ë°”ë€” ìˆ˜ ìˆìœ¼ë‹ˆ ì™€ì¼ë“œì¹´ë“œ ë¨¼ì € â†’ í´ë°±: ê³ ì • íŒŒì¼ëª…
          PID=$(pgrep -f "${APP_NAME}-.*\.jar" || true)
          if [ -z "${PID:-}" ]; then
            PID=$(pgrep -f "${DEFAULT_JAR}" || true)
          fi
          if [ -n "${PID:-}" ]; then
            echo "killing $PID"
            kill -9 "$PID" || true
          else
            echo "no running proc"
          fi

          echo "[3] ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸° (git pull)"
          git pull origin main

          echo "[4] Gradle ë²„ì „ ë° ë¹Œë“œ"
          chmod +x ./gradlew || true
          ./gradlew --version
          ./gradlew clean build -x test

          echo "[4.5] ë¹Œë“œ ì‚°ì¶œë¬¼ ì¡´ì¬ í™•ì¸"
          ls -al build || true
          ls -al build/libs || true

          echo "[5] JAR ìë™ íƒìƒ‰"
          # ë‹¨ì¼/ë©€í‹°ëª¨ë“ˆ ëª¨ë‘ ì§€ì›: ìµœëŒ€ ê¹Šì´ 4ì—ì„œ ê²€ìƒ‰
          echo "[5.1] ìµœê·¼ ìƒì„± JAR ëª©ë¡ (ìƒìœ„ 20ê°œ)"
          find . -maxdepth 4 -type f -path "*/build/libs/*.jar" -printf "%p %TY-%Tm-%Td %TH:%TM\n" | sort -k2,2 -k3,3 | tail -n 20 || true

          JAR_PATH=$(find . -maxdepth 4 -type f -path "*/build/libs/*.jar" | head -n 1 || true)
          if [ -z "${JAR_PATH:-}" ]; then
            echo "âŒ JAR not found under */build/libs"
            echo "[ë””ë²„ê·¸] build ë””ë ‰í† ë¦¬ë“¤:"
            find . -maxdepth 4 -type d -name build -print || true
            exit 1
          fi
          echo "JAR_PATH: $JAR_PATH"

          JAR_DIR=$(dirname "$JAR_PATH")
          JAR_FILE=$(basename "$JAR_PATH")
          echo "â¡ ì‹¤í–‰ ëŒ€ìƒ: $JAR_FILE"
          cd "$JAR_DIR"
          pwd
          ls -al

          echo "[6] nohup ë¡œê·¸ ë°±ì—…"
          mv nohup.out "nohup_$(date +%Y%m%d_%H%M%S).log" 2>/dev/null || true

          echo "[7] ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰"
          nohup java -jar "$JAR_FILE" > nohup.out 2>&1 &
          NEW_PID=$!
          echo "âœ… started: $JAR_FILE (PID: $NEW_PID)"

          echo "[8] ê¸°ë™ ì§í›„ ë¡œê·¸ ë¯¸ë¦¬ë³´ê¸°"
          sleep 2
          tail -n 80 nohup.out || true

          echo "[9] ê°„ì´ í—¬ìŠ¤ì²´í¬ (í¬íŠ¸ ${APP_PORT}, ìµœëŒ€ 60ì´ˆ ëŒ€ê¸°)"
          # ncê°€ ì—†ì„ ìˆ˜ë„ ìˆìœ¼ë¯€ë¡œ curlë¡œë„ ì²´í¬ (ì›í•˜ëŠ” health endpointê°€ ìˆìœ¼ë©´ êµì²´)
          for i in $(seq 1 60); do
            if command -v nc >/dev/null 2>&1; then
              if nc -z localhost "${APP_PORT}"; then
                echo "âœ… í¬íŠ¸ ${APP_PORT} ì—´ë¦¼"; break
              fi
            fi
            if command -v curl >/dev/null 2>&1; then
              if curl -fsS "http://localhost:${APP_PORT}/actuator/health" >/dev/null 2>&1; then
                echo "âœ… /actuator/health í†µê³¼"; break
              fi
            fi
            if [ "$i" -eq 60 ]; then
              echo "âš ï¸ 60ì´ˆ ë‚´ ê¸°ë™ í™•ì¸ ì‹¤íŒ¨(í¬íŠ¸/í—¬ìŠ¤ì²´í¬). ë¡œê·¸ í™•ì¸ ê¶Œì¥."
              break
            fi
            sleep 1
          done

          echo "[10] ìµœì¢… í”„ë¡œì„¸ìŠ¤/í¬íŠ¸ ìƒíƒœ"
          ps -ef | grep java || true
          (command -v ss >/dev/null 2>&1 && ss -ltnp | grep ":${APP_PORT}" ) || true

          echo "ğŸ‰ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì¢…ë£Œ"
          EOS

          chmod +x deploy_remote.sh
          echo "== local deploy_remote.sh created =="
          ls -al deploy_remote.sh
          echo "== file content (head) =="
          head -n 40 deploy_remote.sh

      - name: ğŸ“¤ Upload deploy script to EC2
        shell: bash
        run: |
          scp -o StrictHostKeyChecking=no ./deploy_remote.sh "${{ secrets.EC2_USER }}"@"${{ secrets.EC2_HOST }}":/home/ubuntu/deploy_remote.sh

      - name: ğŸš€ Run deploy script on EC2
        shell: bash
        run: |
          ssh -o StrictHostKeyChecking=no "${{ secrets.EC2_USER }}"@"${{ secrets.EC2_HOST }}" "bash /home/ubuntu/deploy_remote.sh"
